#!/usr/bin/env python

import argparse
import logging
import os
import shutil
import sys

import buildcat

parser = argparse.ArgumentParser("Command line client for Buildcat: the portable, lightweight render farm.")
parser.add_argument("--debug", action="store_true", help="Verbose logging output.")
subparsers = parser.add_subparsers(title="commands (choose one)", dest="command")

subparser = subparsers.add_parser("install", help="Install buildcat integrations.")
#subparser = subparsers.add_parser("houdini", help="Submit a SideFX Houdini render job.")
#subparser = subparsers.add_parser("server", help="Start a buildcat worker.")
#subparser = subparsers.add_parser("worker", help="Start a buildcat worker.")

arguments = parser.parse_args()

if arguments.command is None:
    parser.print_help()

logging.basicConfig(level=logging.DEBUG if arguments.debug else logging.INFO)
log = logging.getLogger()
log.name = os.path.basename(sys.argv[0])

# Install integration resources
if arguments.command == "install":
    buildcat_dir = os.path.dirname(buildcat.__file__)
    integrations_dir = os.path.join(buildcat_dir, "integrations")
    target_dir = os.getcwd()

    log.info("Copying files from {}".format(integrations_dir))
    for dirpath, dirnames, filenames in os.walk(integrations_dir):
        for filename in filenames:
            relative_path = os.path.join(os.path.basename(dirpath), filename)
            log.info("Copying {}".format(relative_path))
            if not os.path.exists(os.path.basename(dirpath)):
                os.makedirs(os.path.basename(dirpath))
            shutil.copy2(os.path.join(dirpath, filename), relative_path)
    log.info("Installation complete.")
